<Page x:Class="RevitAI.UI.ChatPane"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="clr-namespace:RevitAI.UI"
      xmlns:converters="clr-namespace:RevitAI.UI.Converters"
      xmlns:behaviors="clr-namespace:RevitAI.UI.Behaviors"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      Title="RevitAI Chat"
      Background="{DynamicResource BackgroundBrush}">

    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/RevitAI;component/UI/Themes/SharedStyles.xaml"/>
                <ResourceDictionary Source="/RevitAI;component/UI/Themes/LightTheme.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Converters -->
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
            <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
            <converters:MessageRoleToAlignmentConverter x:Key="RoleToAlignment"/>

            <!-- Message DataTemplate -->
            <DataTemplate x:Key="MessageTemplate" DataType="{x:Type local:ChatMessage}">
                <Border HorizontalAlignment="{Binding Role, Converter={StaticResource RoleToAlignment}}">
                    <Border.Style>
                        <Style TargetType="Border" BasedOn="{StaticResource MessageCardStyle}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Role}" Value="User">
                                    <Setter Property="Background" Value="{DynamicResource UserMessageBackgroundBrush}"/>
                                    <Setter Property="BorderBrush" Value="{DynamicResource UserMessageBorderBrush}"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Role}" Value="Assistant">
                                    <Setter Property="Background" Value="{DynamicResource AssistantMessageBackgroundBrush}"/>
                                    <Setter Property="BorderBrush" Value="{DynamicResource AssistantMessageBorderBrush}"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Role}" Value="System">
                                    <Setter Property="Background" Value="{DynamicResource SystemMessageBackgroundBrush}"/>
                                    <Setter Property="BorderBrush" Value="{DynamicResource SystemMessageBorderBrush}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Role indicator -->
                        <TextBlock Grid.Row="0"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   Margin="0,0,0,6">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Role}" Value="User">
                                            <Setter Property="Text" Value="You"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Role}" Value="Assistant">
                                            <Setter Property="Text" Value="RevitAI"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Role}" Value="System">
                                            <Setter Property="Text" Value="System"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- Message content -->
                        <TextBlock Grid.Row="1"
                                   Text="{Binding Content}"
                                   TextWrapping="Wrap"
                                   Foreground="{DynamicResource PrimaryTextBrush}"
                                   FontSize="14"
                                   LineHeight="20"/>

                        <!-- Streaming indicator -->
                        <StackPanel Grid.Row="2"
                                    Orientation="Horizontal"
                                    Margin="0,8,0,0"
                                    Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVisibility}}">
                            <Ellipse Width="6" Height="6"
                                     Fill="{DynamicResource StreamingIndicatorBrush}"
                                     Margin="0,0,4,0">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsStreaming}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard>
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="1" To="0.3" Duration="0:0:0.5"
                                                                             AutoReverse="True"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <TextBlock Text="Typing..."
                                       FontSize="11"
                                       Foreground="{DynamicResource SecondaryTextBrush}"/>
                        </StackPanel>

                        <!-- Error indicator -->
                        <TextBlock Grid.Row="2"
                                   Text="{Binding ErrorMessage, StringFormat='Error: {0}'}"
                                   FontSize="11"
                                   Foreground="{DynamicResource ErrorBrush}"
                                   Margin="0,8,0,0"
                                   TextWrapping="Wrap">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Status}" Value="Error">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- Cancelled indicator -->
                        <TextBlock Grid.Row="2"
                                   Text="Cancelled"
                                   FontSize="11"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   FontStyle="Italic"
                                   Margin="0,8,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Status}" Value="Cancelled">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                </Border>
            </DataTemplate>
        </ResourceDictionary>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0"
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="RevitAI Chat"
                           Style="{StaticResource HeaderTextStyle}"
                           VerticalAlignment="Center"/>

                <Button Grid.Column="1"
                        Content="Clear"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Command="{Binding ClearConversationCommand}"
                        ToolTip="Clear conversation and start fresh"
                        Margin="0,0,8,0"/>

                <Button Grid.Column="2"
                        x:Name="SettingsButton"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Command="{Binding OpenSettingsCommand}"
                        ToolTip="Settings"
                        Padding="8,4"
                        MinWidth="32">
                    <TextBlock Text="&#x2699;"
                               FontSize="16"
                               FontFamily="Segoe UI Symbol"/>
                </Button>
            </Grid>
        </Border>

        <!-- Messages List -->
        <ListView Grid.Row="1"
                  x:Name="MessagesList"
                  ItemsSource="{Binding Messages}"
                  ItemTemplate="{StaticResource MessageTemplate}"
                  Background="Transparent"
                  BorderThickness="0"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                  VirtualizingPanel.ScrollUnit="Pixel"
                  Padding="8">
            <i:Interaction.Behaviors>
                <behaviors:AutoScrollBehavior/>
            </i:Interaction.Behaviors>
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <ContentPresenter/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>
        </ListView>

        <!-- Status Bar -->
        <Border Grid.Row="2"
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8"
                Visibility="{Binding ShowStatus, Converter={StaticResource BoolToVisibility}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <ProgressBar Grid.Column="0"
                             IsIndeterminate="True"
                             Width="100"
                             Height="4"
                             Margin="0,0,12,0"
                             Foreground="{DynamicResource PrimaryBrush}"/>

                <TextBlock Grid.Column="1"
                           Text="{Binding StatusText}"
                           Style="{StaticResource StatusTextStyle}"
                           VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Input Area -->
        <Border Grid.Row="3"
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Screenshot Toggle -->
                <ToggleButton Grid.Column="0"
                              x:Name="ScreenshotToggle"
                              IsChecked="{Binding IncludeScreenshot}"
                              ToolTip="Include screenshot of current view with message"
                              Padding="8"
                              Margin="0,0,8,0"
                              VerticalAlignment="Bottom"
                              MinWidth="36"
                              MinHeight="36">
                    <ToggleButton.Style>
                        <Style TargetType="ToggleButton">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                            <Setter Property="BorderThickness" Value="1"/>
                            <Setter Property="Foreground" Value="{DynamicResource SecondaryTextBrush}"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                CornerRadius="4"
                                                Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Center"
                                                              VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
                                    <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                                    <Setter Property="Foreground" Value="White"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ToggleButton.Style>
                    <!-- Camera icon using Unicode -->
                    <TextBlock Text="&#x1F4F7;"
                               FontSize="14"
                               FontFamily="Segoe UI Emoji"/>
                </ToggleButton>

                <TextBox Grid.Column="1"
                         x:Name="InputTextBox"
                         Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource InputTextBoxStyle}"
                         MaxHeight="120"
                         MinHeight="40"
                         Margin="0,0,12,0"
                         PreviewKeyDown="InputTextBox_PreviewKeyDown"
                         IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibility}, ConverterParameter=bool}">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding SendCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>

                <StackPanel Grid.Column="2"
                            Orientation="Vertical"
                            VerticalAlignment="Bottom">
                    <!-- Send Button -->
                    <Button Content="Send"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding SendCommand}"
                            Visibility="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibility}}"
                            MinWidth="80"/>

                    <!-- Cancel Button -->
                    <Button Content="Cancel"
                            Style="{StaticResource DangerButtonStyle}"
                            Command="{Binding CancelCommand}"
                            Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibility}}"
                            MinWidth="80"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
