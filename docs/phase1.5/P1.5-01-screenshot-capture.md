# P1.5-01: Screenshot Capture

**Status**: Pending

**Goal**: Enable Claude to capture screenshots of the Revit window for visual analysis via the Claude Vision API.

**Prerequisites**: P1-08 complete.

---

## Files Created

```
src/RevitAI/
├── Tools/
│   └── ViewTools/
│       └── CaptureScreenshotTool.cs    # capture_screenshot tool
└── Services/
    └── ScreenCaptureService.cs         # Windows screen capture logic
```

**Modified**:
- `src/RevitAI/App.cs` - Register tool
- `src/RevitAI/Services/ClaudeApiService.cs` - Handle image content blocks

---

## Tool Summary

| Tool Name | Input | Output | Notes |
|-----------|-------|--------|-------|
| `capture_screenshot` | `include_ui?: bool` (default: true) | Base64 PNG image | Full window or view only |

---

## Implementation Details

### Approach Options

#### Option A: Full Window Capture (Recommended)

Captures the entire Revit application window including ribbon, Project Browser, Properties panel, and view canvas. Provides maximum context for Claude to understand the UI state.

```csharp
public class ScreenCaptureService
{
    [DllImport("user32.dll")]
    private static extern bool GetWindowRect(IntPtr hWnd, out RECT lpRect);

    [StructLayout(LayoutKind.Sequential)]
    private struct RECT
    {
        public int Left, Top, Right, Bottom;
    }

    public byte[] CaptureRevitWindow(UIApplication uiApp)
    {
        // Get Revit main window handle
        IntPtr hwnd = uiApp.MainWindowHandle;

        GetWindowRect(hwnd, out RECT rect);
        int width = rect.Right - rect.Left;
        int height = rect.Bottom - rect.Top;

        using var bitmap = new Bitmap(width, height);
        using var graphics = Graphics.FromImage(bitmap);

        graphics.CopyFromScreen(
            rect.Left, rect.Top,
            0, 0,
            new Size(width, height),
            CopyPixelOperation.SourceCopy);

        using var stream = new MemoryStream();
        bitmap.Save(stream, ImageFormat.Png);
        return stream.ToArray();
    }
}
```

#### Option B: View-Only Capture (Alternative)

Uses Revit's built-in `ExportImage` for cleaner view capture without UI chrome:

```csharp
public byte[] CaptureActiveView(UIDocument uiDoc)
{
    var view = uiDoc.ActiveView;
    var tempPath = Path.Combine(Path.GetTempPath(), $"revitai_capture_{Guid.NewGuid()}.png");

    try
    {
        var options = new ImageExportOptions
        {
            FilePath = tempPath,
            ExportRange = ExportRange.CurrentView,
            ZoomType = ZoomFitType.FitToPage,
            PixelSize = 1920, // Width in pixels
            ImageResolution = ImageResolution.DPI_150,
            HLRandWFViewsFileType = ImageFileType.PNG
        };

        uiDoc.Document.ExportImage(options);
        return File.ReadAllBytes(tempPath);
    }
    finally
    {
        if (File.Exists(tempPath))
            File.Delete(tempPath);
    }
}
```

### Tool Implementation

```csharp
public class CaptureScreenshotTool : IRevitTool
{
    private readonly ScreenCaptureService _captureService = new();

    public string Name => "capture_screenshot";

    public string Description =>
        "Captures a screenshot of the Revit window for visual analysis. " +
        "Use this to see what the user sees, verify element placement, " +
        "or understand the current view state.";

    public JsonElement InputSchema => JsonDocument.Parse("""
        {
            "type": "object",
            "properties": {
                "include_ui": {
                    "type": "boolean",
                    "description": "Include Revit UI (ribbon, browser, properties). Default true.",
                    "default": true
                }
            }
        }
        """).RootElement;

    public bool RequiresTransaction => false;

    public Task<ToolResult> ExecuteAsync(JsonElement input, UIApplication app, CancellationToken ct)
    {
        var includeUi = true;
        if (input.TryGetProperty("include_ui", out var includeUiProp))
            includeUi = includeUiProp.GetBoolean();

        byte[] imageBytes;
        if (includeUi)
        {
            imageBytes = _captureService.CaptureRevitWindow(app);
        }
        else
        {
            imageBytes = _captureService.CaptureActiveView(app.ActiveUIDocument);
        }

        var base64 = Convert.ToBase64String(imageBytes);

        return Task.FromResult(ToolResult.SuccessWithImage(base64, "image/png"));
    }
}
```

### ToolResult Extension for Images

Extend `ToolResult` to support image content:

```csharp
public class ToolResult
{
    // Existing properties...
    public string? ImageBase64 { get; init; }
    public string? ImageMediaType { get; init; }

    public static ToolResult SuccessWithImage(string base64, string mediaType)
    {
        return new ToolResult
        {
            Success = true,
            ImageBase64 = base64,
            ImageMediaType = mediaType,
            Data = new { captured = true, format = mediaType }
        };
    }
}
```

### ClaudeApiService Integration

Update message construction to include image content blocks:

```csharp
private Content BuildToolResultContent(ToolResult result)
{
    if (result.ImageBase64 != null)
    {
        // Return image content block for Claude vision
        return new Content
        {
            Type = "tool_result",
            ToolUseId = result.ToolUseId,
            Content = new object[]
            {
                new
                {
                    type = "image",
                    source = new
                    {
                        type = "base64",
                        media_type = result.ImageMediaType,
                        data = result.ImageBase64
                    }
                }
            }
        };
    }

    // Existing text-only result handling...
}
```

---

## API Key Considerations

Screenshots sent to Claude Vision increase token usage significantly:
- A 1920x1080 image uses approximately 1,500-2,000 tokens
- Higher resolutions use more tokens proportionally

Consider adding configuration options (P1-10) to:
- Set maximum image resolution
- Enable/disable screenshot capability
- Warn users about increased API costs

---

## Error Handling

| Scenario | Handling |
|----------|----------|
| Window minimized | Return error: "Cannot capture screenshot while Revit is minimized" |
| No active view | Return error: "No active view to capture" |
| Capture fails | Log exception, return error with details |
| File system issues (Option B) | Use temp directory with cleanup |

---

## Verification Checklist

- [ ] Full window capture includes ribbon, browser, properties, and view canvas
- [ ] View-only capture produces clean view image without UI
- [ ] Base64 output is valid and can be decoded to PNG
- [ ] Image appears in Claude's tool_result and Claude can describe what it sees
- [ ] Temporary files (if any) are cleaned up
- [ ] Works when Revit is maximized, normal, and resized
- [ ] Handles multi-monitor setups correctly

---

## Usage Examples

### Claude requesting a screenshot to verify placement

```
User: Place a column at grid intersection A-1

Claude: I'll place the column and verify the placement.
[calls place_column tool]
[calls capture_screenshot tool]

Looking at the screenshot, I can see the column has been placed
correctly at the intersection of grids A and 1. The column appears
as a W10x49 steel shape oriented with its web perpendicular to grid A.
```

### Claude using screenshot to understand user's view

```
User: What's wrong with this wall?

Claude: Let me take a screenshot to see what you're looking at.
[calls capture_screenshot tool]

I can see in the screenshot that you're viewing a wall in elevation.
The wall shows a warning indicator (yellow triangle). The issue appears
to be that the wall's top constraint extends above the roof line.
Would you like me to adjust the wall's top constraint?
```

---

## Future Enhancements (Deferred)

| Enhancement | Target Phase | Notes |
|-------------|--------------|-------|
| Automatic screenshot on context change | P2-04 | Optional auto-capture when view changes |
| Screenshot annotation | P2-05 | Claude could annotate images with callouts |
| Multi-view capture | P2-05 | Capture multiple views in one call |
| Configurable resolution | P1-10 | User setting for image quality vs. cost |
