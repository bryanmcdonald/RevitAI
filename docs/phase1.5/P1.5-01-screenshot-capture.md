# P1.5-01: Screenshot Capture

**Status**: Complete

**Goal**: Enable Claude to capture screenshots of the Revit window for visual analysis via the Claude Vision API.

**Prerequisites**: P1-08 complete.

---

## Files Created

```
src/RevitAI/
├── Tools/
│   └── ViewTools/
│       └── CaptureScreenshotTool.cs    # capture_screenshot tool
└── Services/
    └── ScreenCaptureService.cs         # Windows screen capture + Revit export
```

**Modified**:
- `src/RevitAI/App.cs` - Register tool
- `src/RevitAI/Models/ApiSettings.cs` - Add ScreenshotResolution and ScreenshotToolState enums
- `src/RevitAI/Services/ConfigurationService.cs` - Add screenshot settings persistence
- `src/RevitAI/Tools/ToolResult.cs` - Add image support
- `src/RevitAI/Models/ClaudeModels.cs` - Update ToolResultBlock for image content
- `src/RevitAI/Tools/ToolDispatcher.cs` - Handle image results
- `src/RevitAI/Tools/ToolRegistry.cs` - Add conditional tool filtering
- `src/RevitAI/UI/ChatViewModel.cs` - Add screenshot state cycling
- `src/RevitAI/UI/ChatPane.xaml` - Add cycling toggle button
- `src/RevitAI/RevitAI.csproj` - Add System.Drawing.Common package

---

## Tool Summary

| Tool Name | Input | Output | Notes |
|-----------|-------|--------|-------|
| `capture_screenshot` | `include_ui?: bool`, `resolution?: string` | Base64 PNG image | Full window or view only |

---

## Design Decisions

| Decision | Choice |
|----------|--------|
| Capture scope | Two options: full window (UI) or view-only export |
| Resolution control | Claude chooses per-capture, falls back to user default |
| Resolution format | Named presets with explicit pixel widths |
| Default resolution | `medium` (1280px) |
| Window resize behavior | Resize full-window captures to match preset |
| Enable/disable control | Cycling button near chat input (off → one-time → always) |
| Non-graphical views | Auto-fallback to full-window capture |
| Rate limit | Max 10 screenshots per AI response (resets on each user message) |
| Token feedback | Include estimated tokens in tool result |

### Resolution Presets

| Preset | Width | Approx. Tokens | Use Case |
|--------|-------|----------------|----------|
| `low` | 800px | ~500-700 | Quick overview, layout verification |
| `medium` | 1280px | ~800-1000 | General analysis, element identification |
| `high` | 1920px | ~1500-2000 | Detail work, reading small text |
| `max` | 2560px | ~2500-3500 | Fine detail, dimension reading |

---

## Implementation Details

### ScreenCaptureService

Handles both capture modes:

1. **CaptureRevitWindow** - Windows API capture via `CopyFromScreen` + resize
2. **CaptureActiveView** - Revit's `ExportImage` API for clean graphical view export
3. **CanExportView** - Determines if view supports ExportImage (graphical views only)
4. **ResizeImage** - High-quality bicubic resize to target resolution

### CaptureScreenshotTool

The tool implementation with:
- Auto-fallback to full window for non-exportable views (schedules, sheets, browsers)
- Rate limiting per AI response
- Token estimate feedback in result text (Claude instructed to report this to users)
- Resolution guidance in tool description

### System Prompt QC Guidance

When screenshots are enabled (Always mode), the system prompt includes rigorous QC instructions:

**Structural/Framing QC:**
- Beam/column connections (frame INTO members, not to centerlines)
- Visual clash detection
- Grid alignment
- Elevation correctness

**Annotation/Documentation QC:**
- Missing tags on NEW elements
- Tag style consistency
- Dimension validity
- Orphaned annotations

**Visual/Drafting QC:**
- Linework quality
- Line weights/styles
- View readability
- Construction document acceptability

Claude is instructed to report issues even when it cannot fix them (no tool available), providing actionable feedback to the user.

### UI Controls

Three-state cycling button:
1. **Off** - No screenshots, tool not available to Claude
2. **One-time (1x)** - Screenshot auto-attached to each user message
3. **Always (Auto)** - Claude can call `capture_screenshot` tool autonomously

Visual feedback:
- Gray = Off
- Blue = One-time mode
- Green = Always mode

---

## Error Handling

| Scenario | Handling |
|----------|----------|
| Window minimized | Return error: "Cannot capture screenshot while Revit is minimized" |
| No active document | Return error: "No active document. Please open a Revit project first." |
| View-only for non-graphical view | Auto-fallback to full window capture (not an error) |
| Rate limit exceeded | Return error with count/max and instruction to send new message |
| Capture fails | Log exception, return error with details |

---

## Verification Checklist

- [x] Full window capture includes ribbon, browser, properties, and view canvas
- [x] View-only capture produces clean view image without UI
- [x] Auto-fallback works for schedules, sheets, and browser views
- [x] Base64 output is valid and can be decoded to PNG
- [x] Image appears in Claude's tool_result (via Vision API format)
- [x] Resolution presets produce correctly-sized images
- [x] Toggle button cycles through all three states
- [x] State persists across sessions
- [x] Rate limiting enforces 10 screenshots per response
- [x] Token estimates shown in tool result
- [x] Build succeeds with no warnings from new code

---

## Usage Examples

### Claude requesting a screenshot to verify placement

```
User: Place a column at grid intersection A-1

Claude: I'll place the column and verify the placement.
[calls place_column tool]
[calls capture_screenshot with resolution: "medium"]

Looking at the screenshot, I can see the column has been placed
correctly at the intersection of grids A and 1. The column appears
as a W10x49 steel shape oriented with its web perpendicular to grid A.
```

### One-time mode for user context sharing

```
User: [has OneTime mode enabled]
User: What's wrong with this wall?

[Screenshot automatically attached to message]

Claude: I can see in the screenshot that you're viewing a wall in elevation.
The wall shows a warning indicator (yellow triangle). The issue appears
to be that the wall's top constraint extends above the roof line.
Would you like me to adjust the wall's top constraint?
```

---

## Dependencies Added

- **System.Drawing.Common** (8.0.0) - For Bitmap operations in window capture

---

## Future Enhancements (Deferred)

| Enhancement | Target Phase | Notes |
|-------------|--------------|-------|
| Automatic screenshot on context change | P2-04 | Optional auto-capture when view changes |
| Screenshot annotation | P2-05 | Claude could annotate images with callouts |
| Multi-view capture | P2-05 | Capture multiple views in one call |
| Configurable rate limit | Settings | User setting for max screenshots per response |
| Thumbnail preview in chat | P2-05 | Show captured images inline in chat |
