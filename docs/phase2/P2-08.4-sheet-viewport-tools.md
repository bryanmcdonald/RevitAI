# P2-08.4: Sheet & Viewport Tools

**Goal**: Place views on sheets as viewports and auto-arrange viewport layouts.

**Prerequisites**: P2-08.1 complete (DraftingHelper).

**Status**: Complete

---

## Tools (2)

| Tool | Purpose | RequiresTransaction |
|------|---------|---------------------|
| `place_viewport` | Place view on sheet (with title/type options) | true |
| `auto_arrange_viewports` | Auto-layout viewports (grid/column/auto) | true |

---

## Files to Create

```
src/RevitAI/Tools/DraftingTools/
    PlaceViewportTool.cs
    AutoArrangeViewportsTool.cs
```

---

## Key API Details

### Viewport Creation
```csharp
Viewport.CanAddViewToSheet(doc, sheetId, viewId);
var viewport = Viewport.Create(doc, sheetId, viewId, centerPoint);
```

### Auto-Arrange Algorithm
Row-based bin packing:
1. Get all viewports on sheet via `sheet.GetAllViewports()`
2. Get each viewport's bounding box via `GetBoxOutline()`
3. Sort by height (tallest first)
4. Place left-to-right with spacing
5. New row when width exceeded
6. Center rows horizontally
7. Fall back to standard sheet dims (34"x22" for D-size) if title block BB unavailable

### Viewport Properties
```csharp
viewport.GetBoxCenter();  // Current center
viewport.GetBoxOutline(); // Bounding box
viewport.SetBoxCenter(newCenter);  // Reposition
```

---

## Verification (Manual)

1. Create a sheet and several views
2. "Place Floor Plan Level 1 on sheet A101 at the center"
3. "Auto-arrange all viewports on sheet A101"
4. Verify viewports don't overlap and are reasonably laid out

---

## Implementation Notes

### Files Created
- `src/RevitAI/Tools/DraftingTools/PlaceViewportTool.cs` — `place_viewport` tool
- `src/RevitAI/Tools/DraftingTools/AutoArrangeViewportsTool.cs` — `auto_arrange_viewports` tool

### DraftingHelper Extensions Added
- `ResolveSheet(doc, input)` — Resolves ViewSheet by `sheet_id` or `sheet_number` (case-insensitive)
- `ResolveViewForViewport(doc, input)` — Resolves View by `view_id` or `view_name` with exact, contains, and Levenshtein fuzzy matching. Rejects templates and sheets.
- `GetSheetUsableArea(doc, sheet)` — Returns min/max corners based on title block bounding box, with D-size fallback (34"x22")
- Private `LevenshteinDistance` — Case-insensitive edit distance for fuzzy view name matching

### Design Decisions
- **Sheet resolution**: Both `sheet_id` and `sheet_number` supported; error messages list available sheets
- **View resolution**: Three-tier matching (exact → contains → fuzzy Levenshtein) with threshold `max(2, length/3)`
- **Default center**: When no `center` param provided, viewport placed at center of sheet usable area
- **Already-placed view detection**: `FindSheetContainingView` helper scans all sheets to give descriptive error when view is already placed
- **Auto-arrange spacing/margin**: Parameters in inches (user-friendly), converted to feet internally
- **Layout modes**: `auto` (row-based bin packing), `grid` (equal cells), `column` (vertical stack)
- **Single viewport**: Centered in usable area regardless of layout mode
- **Zero viewports**: Returns informational message, no error

### Known Limitation: Viewport Sizing

Placed viewports inherit the view's current scale (`view.Scale`). Views at detailed scales (e.g., 1:100) may produce viewports that overflow the sheet. The tools position viewports correctly but cannot resize them. A future `set_view_scale` tool is tracked in [P1.5-02 Future Enhancements](../phase1.5/P1.5-02-view-management.md#future-enhancements-deferred).
