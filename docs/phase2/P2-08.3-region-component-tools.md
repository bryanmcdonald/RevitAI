# P2-08.3: Region + Component Tools

**Goal**: Enable creation of filled regions, masking regions, custom region types, and placement of detail components and groups.

**Prerequisites**: P2-08.1 complete (DraftingHelper — `BuildClosedCurveLoop`, `ResolveDetailView`, `ParsePointArray`).

**Status**: Complete

---

## Tools (5)

| Tool | Purpose | RequiresTransaction |
|------|---------|---------------------|
| `place_filled_region` | Hatched/filled area with pattern | true |
| `place_masking_region` | White-out masking area | true |
| `create_filled_region_type` | Create new region type (pattern + color) | true |
| `place_detail_component` | Insert detail component family | true |
| `place_detail_group` | Place detail group instance | true |

---

## Files to Create

```
src/RevitAI/Tools/DraftingTools/
    PlaceFilledRegionTool.cs
    PlaceMaskingRegionTool.cs
    CreateFilledRegionTypeTool.cs
    PlaceDetailComponentTool.cs
    PlaceDetailGroupTool.cs
```

---

## Key API Details

### FilledRegion
```csharp
FilledRegion.Create(doc, regionTypeId, viewId, new List<CurveLoop> { curveLoop });
```

### Masking Region
Same API as filled region but uses a `FilledRegionType` where `IsMasking == true` and `ForegroundPatternId == InvalidElementId` (no visible pattern). The tool uses a 3-tier resolution: existing pure masking type > duplicate a masking type and clear its pattern > create from any type with `IsMasking = true`.

### Creating FilledRegionType
Duplicate an existing type and set pattern/color:
```csharp
var existing = new FilteredElementCollector(doc)
    .OfClass(typeof(FilledRegionType))
    .Cast<FilledRegionType>()
    .First();
var newType = existing.Duplicate(name) as FilledRegionType;
newType.ForegroundPatternId = patternElement.Id;
newType.ForegroundPatternColor = new Color(r, g, b);
```

### Detail Component Placement
```csharp
doc.Create.NewFamilyInstance(location, symbol, view);
```
Must call `symbol.Activate()` if not already active.

### Detail Group Placement
```csharp
var groupType = doc.GetElement(groupTypeId) as GroupType;
// Filter by GroupType.GroupKind for detail groups
doc.Create.PlaceGroup(location, groupType);
```

---

## Implementation Notes

### PlaceFilledRegionTool — 3-Tier Type Resolution
Uses a resolution strategy: explicit `region_type_name` > match by `fill_pattern_name` on foreground pattern > first non-masking type. If `fill_pattern_name` is specified but not matched, fails explicitly rather than falling through to default (consistency with Tier 1 behavior).

### PlaceDetailGroupTool — No `view_id` Parameter
`doc.Create.PlaceGroup(location, groupType)` does not accept a view parameter — it always places in the active view. The tool validates the active view directly instead of using `DraftingHelper.ResolveDetailView`. This differs from other drafting tools that accept `view_id`.

### CreateFilledRegionTypeTool — `ToolResult.Ok` (not `OkWithElements`)
Type elements are not selectable in the viewport, so `ToolResult.Ok()` is used instead of `OkWithElements()`. Passing a type element ID to `uidoc.Selection.SetElementIds()` would be a no-op or produce unexpected behavior.

### Color Parsing — `GetDouble()` Instead of `GetInt32()`
AI models sometimes serialize integer values as floats (e.g., `255.0` instead of `255`). `JsonElement.GetInt32()` throws on decimal values, so `GetDouble()` with cast is used for robustness.

### Detail Group Filtering
Groups are filtered by `Category.BuiltInCategory == OST_IOSDetailGroups` rather than `GroupType.GroupKind`. Both approaches identify detail groups; the category-based approach is more conventional in Revit API usage.

### Transaction Failure Handling — `SilentFailuresPreprocessor`
All transactions created by `TransactionManager.StartTransaction` are configured with `SilentFailuresPreprocessor` and `SetForcedModalHandling(false)`. Without this, any tool operation that triggers a Revit warning (e.g., masking region creation) causes Revit to show a modal failure dialog that blocks the `ExternalEvent` thread indefinitely (permanent hang). The preprocessor deletes warnings silently and lets errors roll back automatically.

### PlaceMaskingRegionTool — 3-Tier Type Resolution
Simply checking `IsMasking == true` is insufficient — some masking types have a visible foreground pattern, which produces a visually hatched region instead of a blank white mask. The tool uses `ResolveMaskingType()` with three tiers:
1. **Pure masking**: `IsMasking && ForegroundPatternId == InvalidElementId`
2. **Duplicate + clear**: If a masking type exists with a pattern, duplicate it and clear the foreground pattern
3. **Create from scratch**: If no masking type exists, duplicate any type and set `IsMasking = true` with no pattern

---

## Verification (Manual)

1. "Create a concrete-filled region from (0,0) to (10,10)"
2. "Add a masking region over area (5,5) to (15,15)"
3. "Create a new region type called 'Cross Hatch Red' with diagonal pattern in red"
4. "Insert a break line symbol at location 5,5"
5. "Place detail group 'Typical Section' at 10,10"
