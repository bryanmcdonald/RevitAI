# P2-08.6: Batch Tools

**Goal**: Enable high-volume drafting operations by batching multiple detail lines or components in a single tool call.

**Prerequisites**: P2-08.1 complete (DraftingHelper). Follows `BulkModifyParametersTool` pattern from P2-06.

**Status**: Complete

---

## Tools (2)

| Tool | Purpose | RequiresTransaction | Max Items |
|------|---------|---------------------|-----------|
| `batch_place_detail_lines` | Multiple detail lines in one call | true | 200 |
| `batch_place_detail_components` | Multiple components in one call | true | 100 |

---

## Files to Create

```
src/RevitAI/Tools/DraftingTools/
    BatchPlaceDetailLinesTool.cs
    BatchPlaceDetailComponentsTool.cs
```

---

## Error Handling Pattern

Following `BulkModifyParametersTool`:
- Track `succeeded` / `failed` / `errors` (cap error messages at 5)
- Return `OkWithElements` with all successful element IDs
- Return `Error` only if ALL items fail
- Partial success returns OK with summary

```json
{
  "succeeded": 45,
  "failed": 2,
  "total": 47,
  "errors": ["Line 3: start and end points are identical", "Line 17: line style 'Foo' not found"],
  "element_ids": [12345, 12346, ...]
}
```

---

## Key API Details

### Batch Detail Lines
Each item in the array:
```json
{
  "start": [x, y],
  "end": [x, y],
  "line_style": "Medium Lines"  // optional
}
```

All lines placed in the same view (single `view_id` param at top level).

### Batch Detail Components
Each item in the array:
```json
{
  "type_name": "Break Line",
  "location": [x, y],
  "rotation": 45  // optional, degrees
}
```

All components from the same family (single `family_name` param at top level).

---

## Verification (Manual)

1. "Draw a grid of 20 detail lines spaced 1 foot apart"
2. "Place 10 break line symbols at the following locations: ..."
3. Verify performance is acceptable for max batch sizes
4. Verify partial failures are reported correctly

---

## Implementation Notes

### Line Style Caching
Both tools pre-cache expensive lookups before the placement loop. `BatchPlaceDetailLinesTool` builds a `Dictionary<string, GraphicsStyle?>` for all unique style names in the input, resolving each via `ElementLookupHelper.FindLineStyle()` exactly once. Missing styles get `null` entries to avoid re-lookup.

### Family/Symbol Caching
`BatchPlaceDetailComponentsTool` resolves the family existence once upfront, then caches each unique `type_name` as `"family_name: type_name"` via `FindFamilySymbolInCategoryFuzzy`. Symbols are activated during the cache-building phase.

### Point Parsing Optimization
Both tools use inline `ParsePointFromItem` methods that avoid `ToList()` allocation by using indexed array access (`element[0]`, `element[1]`, etc.) directly on the `JsonElement`.

### Partial Success Semantics
- A line placed with an invalid style name counts as **succeeded** (the element exists) with a warning in the errors list
- Only lines that fail to create (e.g., coincident start/end points) count as **failed**
- `Error` is returned only when `succeeded == 0` AND no elements were created
