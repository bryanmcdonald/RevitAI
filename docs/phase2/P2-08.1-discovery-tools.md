# P2-08.1: DraftingHelper + Discovery Tools

**Goal**: Create the shared DraftingHelper utility class and 6 read-only discovery tools that help the AI understand what drafting resources are available in the current document.

**Prerequisites**: P2-01 complete (provides `create_sheet`, `place_detail_line`, `place_text_note`).

**Status**: Complete

---

## Overview

Discovery tools are essential for the AI to make informed decisions about drafting operations. Before placing a filled region, the AI needs to know what fill patterns exist. Before applying a line style, it needs to know what styles are available. These tools provide that information.

The DraftingHelper class provides shared validation and parsing utilities used by all 25+ tools across P2-08 sub-chunks.

---

## Files to Create

| File | Purpose |
|------|---------|
| `src/RevitAI/Tools/DraftingTools/Helpers/DraftingHelper.cs` | Shared utilities for all drafting tools |
| `src/RevitAI/Tools/DraftingTools/GetFillPatternsTool.cs` | List available fill patterns |
| `src/RevitAI/Tools/DraftingTools/GetLineStylesTool.cs` | List available line styles (structured) |
| `src/RevitAI/Tools/DraftingTools/GetDetailComponentsTool.cs` | List loaded detail component families |
| `src/RevitAI/Tools/DraftingTools/GetRevisionListTool.cs` | List revisions with metadata |
| `src/RevitAI/Tools/DraftingTools/GetSheetListTool.cs` | List sheets with viewport counts |
| `src/RevitAI/Tools/DraftingTools/GetViewportInfoTool.cs` | Get viewport details on a sheet |

**Modified files**: `App.cs` (6 registrations + using statement)

---

## DraftingHelper Utilities

Central utility class returning `(T?, ToolResult?)` tuples for validation:

### ResolveDetailView(doc, input, app)
- Resolves optional `view_id` parameter, falls back to active view
- Validates view is 2D (not 3D, not schedule, not sheet)
- Returns `(View?, ToolResult?)` tuple

### ParsePoint(element, paramName)
- Parses `[x, y]` or `[x, y, z]` JSON array to `XYZ` (in feet)
- Returns `(XYZ?, ToolResult?)` tuple

### ParsePointArray(element, paramName, minPoints)
- Parses array of `[x,y]` points with minimum count validation
- Returns `(List<XYZ>?, ToolResult?)` tuple

### BuildClosedCurveLoop(points)
- Auto-closes boundary if first != last point
- Validates minimum 3 points
- Returns `(CurveLoop?, ToolResult?)` tuple

### ApplyLineStyle(doc, curve, input)
- Reads optional `line_style` parameter
- Delegates to `ElementLookupHelper.FindLineStyle()`
- Returns `(string?, ToolResult?)` - style name applied, or error

### DegreesToRadians(degrees)
- Simple conversion utility

**Reuse (NOT duplicate)**: `ElementLookupHelper.FindLineStyle()`, `GetAvailableLineStyleNames()`, `FindFamilySymbolInCategory()`, `FindFamilySymbolInCategoryFuzzy()`, `CategoryHelper.TryGetCategory()`.

---

## Discovery Tools

### 1. get_fill_patterns
- **Schema**: `{ target?: "drafting" | "model" }` (optional filter)
- **API**: `FilteredElementCollector(doc).OfClass(typeof(FillPatternElement))`
- **Returns**: name, target (drafting/model), is_solid_fill
- **RequiresTransaction**: false

### 2. get_line_styles
- **Schema**: `{}` (no params)
- **API**: Structured version of `ElementLookupHelper.GetAvailableLineStyleNames()`
- **Returns**: name, id for each line style
- **RequiresTransaction**: false

### 3. get_detail_components
- **Schema**: `{ family_name?: string }` (optional filter)
- **API**: `FilteredElementCollector(doc).OfCategory(OST_DetailComponents).WhereElementIsElementType()`
- **Returns**: Groups by family, lists types within each
- **RequiresTransaction**: false

### 4. get_revision_list
- **Schema**: `{}` (no params)
- **API**: `Revision.GetAllRevisionIds(doc)` + property access
- **Returns**: id, sequence_number, date, description, issued, visibility
- **RequiresTransaction**: false

### 5. get_sheet_list
- **Schema**: `{}` (no params)
- **API**: `FilteredElementCollector(doc).OfClass(typeof(ViewSheet))`
- **Returns**: id, number, name, viewport_count
- **RequiresTransaction**: false

### 6. get_viewport_info
- **Schema**: `{ sheet_id: integer }`
- **API**: `sheet.GetAllViewports()` + Viewport properties
- **Returns**: viewport_id, view_name, view_type, detail_number, center, outline
- **RequiresTransaction**: false

---

## Registration

Add to `App.cs` after visual isolation tools (line ~332):

```csharp
// Drafting & documentation tools (P2-08.1) - Discovery
registry.Register(new GetFillPatternsTool());
registry.Register(new GetLineStylesTool());
registry.Register(new GetDetailComponentsTool());
registry.Register(new GetRevisionListTool());
registry.Register(new GetSheetListTool());
registry.Register(new GetViewportInfoTool());
```

---

## Verification (Manual)

1. Open any Revit project
2. Ask: "What fill patterns are available?"
3. Ask: "What line styles can I use?"
4. Ask: "What detail components are loaded?"
5. Ask: "List all revisions in this project"
6. Ask: "Show me all sheets and their viewports"
7. Ask: "What views are on sheet A101?"
8. Verify all return structured JSON with appropriate data

---

## Implementation Notes

- `DraftingHelper.ResolveDetailView` takes `(Document, JsonElement)` — `UIApplication` parameter was removed as unnecessary since `doc.ActiveView` suffices.
- `GetFillPatternsTool` filters by `FillPatternTarget` enum before projecting to DTOs (not after), and null-guards `GetFillPattern()` to handle corrupted pattern data gracefully.
- `GetDetailComponentsTool` caps at 50 families with `Truncated` flag, matching existing `GetAvailableTypesTool` pattern.
- All 6 tools use `SnakeCaseLower` JSON naming and `WhenWritingNull` ignore condition, consistent with all other tools.
- `DraftingHelper` does NOT duplicate any `ElementLookupHelper` methods — it delegates to `FindLineStyle()` and `GetAvailableLineStyleNames()` for line style resolution.
