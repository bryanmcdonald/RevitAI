# P2-08.5: Annotation & Reference Tools

**Goal**: Create callouts, legends, legend components, revision clouds, and set view scale.

**Prerequisites**: P2-08.1 complete (DraftingHelper -- `BuildClosedCurveLoop`, `ParsePointArray`).

**Status**: Complete

---

## Tools (5)

| Tool | Purpose | RequiresTransaction |
|------|---------|---------------------|
| `set_view_scale` | Set view scale (deferred from P1.5-02) | true |
| `place_callout` | Create callout (detail or section) | true |
| `create_legend` | Create legend view (by duplicating existing) | true |
| `place_legend_component` | Add family representation to legend | true |
| `place_revision_cloud` | Draw revision markup cloud | true |

---

## Files Created

```
src/RevitAI/Tools/ViewTools/
    SetViewScaleTool.cs

src/RevitAI/Tools/DraftingTools/
    PlaceCalloutTool.cs
    CreateLegendTool.cs
    PlaceLegendComponentTool.cs
    PlaceRevisionCloudTool.cs
```

## Files Modified

- `DraftingHelper.cs` -- Added `ResolveView()` general-purpose view resolver
- `ElementLookupHelper.cs` -- Added `FindFamilySymbolFuzzy()` cross-category search
- `App.cs` -- Registered 5 new tools

---

## Implementation Notes

### Legend View Creation (API Limitation)
The Revit API does **not** have a `View.CreateLegend()` method. The spec assumed one existed. Instead, `CreateLegendTool` duplicates an existing legend view using `View.Duplicate(ViewDuplicateOption.Duplicate)`, then renames it, sets the scale, and clears any copied elements. This requires at least one legend view to already exist in the project. The tool provides a helpful error message if no legend exists.

### Revision Cloud API
The spec assumed `RevisionCloud.Create(doc, view.Id, revisionId, List<CurveLoop>)`. The actual Revit 2026 API signature is `RevisionCloud.Create(doc, view, revisionId, IList<Curve>)` -- it takes a View object (not ElementId) and a flat list of Curve objects (not CurveLoops). The implementation converts the CurveLoop from `BuildClosedCurveLoop()` to `IList<Curve>` via LINQ `.Cast<Curve>().ToList()`.

### Legend Component View Direction
The `LEGEND_COMPONENT` built-in parameter accepts integer values: 0=Plan, 1=Front, 2=Back, 3=Left, 4=Right. This is set best-effort -- if the parameter doesn't exist or is read-only for a particular family, placement succeeds anyway with default orientation and the result includes a note.

### Cross-Category Fuzzy Matching
`FindFamilySymbolFuzzy` was added to `ElementLookupHelper` because legend components can reference any family type (doors, windows, furniture, etc.), unlike detail components which are restricted to `OST_DetailComponents`. The matching logic is identical to `FindFamilySymbolInCategoryFuzzy` but searches all `FamilySymbol` instances.

### ResolveView vs ResolveDetailView
`DraftingHelper.ResolveView()` was added as a general-purpose view resolver that only rejects view templates. Unlike `ResolveDetailView()` which also rejects 3D views, schedules, and sheets, `ResolveView()` lets callers validate view type suitability themselves. Used by `SetViewScaleTool` and `PlaceRevisionCloudTool`.

---

## Verification (Manual)

1. `set_view_scale`: "Set this view's scale to 48" -- verify scale changes, Ctrl+Z works
2. `create_legend`: "Create a legend called Door Legend" -- verify in Project Browser
3. `place_legend_component`: "Add a Single-Flush 36x84 door to the legend at (0.5, 0.5)" -- verify component appears
4. `place_revision_cloud`: "Add revision cloud from (0,0) to (5,5) to (5,0)" -- verify cloud with revision
5. `place_callout`: "Create a detail callout from (10,10) to (20,20)" -- verify callout + new view created
