# P2-08.2: Linework & Shape Tools

**Goal**: Provide advanced 2D linework tools for arcs, splines, circles, rectangles, ellipses, polylines, and style modification.

**Prerequisites**: P2-08.1 complete (DraftingHelper).

**Status**: Complete

---

## Tools (7)

| Tool | Purpose | RequiresTransaction |
|------|---------|---------------------|
| `place_detail_arc` | Draw arc (center+radius+angles or three-point) | true |
| `place_detail_curve` | Draw splines and hermite curves | true |
| `place_detail_polyline` | Multi-segment connected line sequence | true |
| `place_detail_circle` | Full circle (two semicircular arcs) | true |
| `place_detail_rectangle` | Axis-aligned rectangle from two corners | true |
| `place_detail_ellipse` | Ellipse from center + radii + optional rotation | true |
| `modify_detail_curve_style` | Change line style of existing DetailCurves | true |

---

## Files Created

```
src/RevitAI/Tools/DraftingTools/
    PlaceDetailArcTool.cs
    PlaceDetailCurveTool.cs
    PlaceDetailPolylineTool.cs
    PlaceDetailCircleTool.cs
    PlaceDetailRectangleTool.cs
    PlaceDetailEllipseTool.cs
    ModifyDetailCurveStyleTool.cs
```

## Files Modified

- `src/RevitAI/Tools/DraftingTools/Helpers/DraftingHelper.cs` — Added `CreateDetailCurves` and `ApplyLineStyleToAll` shared helpers
- `src/RevitAI/App.cs` — Registered 7 new tools

---

## Key API Details

### Arc Creation
```csharp
// Center + radius mode
Arc.Create(center, radius, startAngle, endAngle, XYZ.BasisX, XYZ.BasisY);

// Three-point mode (Revit order: start, end, pointOnArc)
Arc.Create(startPt, endPt, midPt);

doc.Create.NewDetailCurve(view, arc);
```

### Spline/Hermite
```csharp
// NurbSpline — control points, curve passes near them
NurbSpline.CreateCurve(points, weights);

// HermiteSpline — curve passes through all points
HermiteSpline.Create(points, periodic: false);
```

### Circle (full 360)
Revit doesn't allow a full 360-degree arc in a single curve. Use two semicircular arcs:
```csharp
var arc1 = Arc.Create(center, radius, 0, Math.PI, XYZ.BasisX, XYZ.BasisY);
var arc2 = Arc.Create(center, radius, Math.PI, 2 * Math.PI, XYZ.BasisX, XYZ.BasisY);
```

### Ellipse
Two half-ellipses with rotated basis vectors for rotation support:
```csharp
var xAxis = new XYZ(Math.Cos(rotationRad), Math.Sin(rotationRad), 0);
var yAxis = new XYZ(-Math.Sin(rotationRad), Math.Cos(rotationRad), 0);
Ellipse.CreateCurve(center, radiusX, radiusY, xAxis, yAxis, 0, Math.PI);
Ellipse.CreateCurve(center, radiusX, radiusY, xAxis, yAxis, Math.PI, 2 * Math.PI);
```

### Rectangle
Four `Line.CreateBound` calls forming an axis-aligned closed boundary from two opposite corners.

### Polyline
Multiple `Line.CreateBound` calls for each segment, with optional closing segment.

---

## DraftingHelper Additions

Two new shared methods added to avoid duplication across multi-curve tools:

- **`CreateDetailCurves(doc, view, curves)`** — Creates multiple DetailCurves from a list of Revit Curve objects. Returns error with index if any curve creation fails.
- **`ApplyLineStyleToAll(doc, curves, input)`** — Reads optional `line_style` from input, resolves GraphicsStyle once, applies to all curves in a single loop.

Single-curve tools (arc, spline) continue to use the existing `ApplyLineStyle` method. Hermite curves use `ApplyLineStyleToAll` since they produce multiple segments.

---

## Implementation Notes

- **Hermite curves**: Revit's `NewDetailCurve` rejects `HermiteSpline` objects. Implemented as Catmull-Rom cubic Bezier segments instead — computes tangent vectors at each point, then creates one cubic `NurbSpline` (4 control points) per point pair. Each segment passes exactly through its endpoint data points, giving smooth C1-continuous interpolation. Returns N-1 element IDs for N data points.
- **Arc mode auto-detection**: If `mode` is not specified, parameters are inspected — presence of `start`/`mid`/`end` triggers three-point mode, otherwise center_radius.
- **Angle normalization**: Arc angles are normalized to [0, 360) range before converting to radians. End angle adjusted by +2PI if <= start angle.
- **Collinearity check**: Three-point arc validates points are not collinear using cross product magnitude > 1e-6.
- **Rectangle Z validation**: Both corners must have matching Z coordinates for the planar axis-aligned rectangle.
- **ModifyDetailCurveStyleTool**: Returns error (not success) when no elements were actually modified, with details about which IDs were invalid or not DetailCurves.
- **Ellipse NurbSpline fallback**: Not implemented. If Revit 2026 rejects `Ellipse.CreateCurve` via `NewDetailCurve`, the outer catch will produce an error. Needs manual testing.

---

## Verification (Manual)

1. Create a drafting view
2. "Draw an arc with radius 5 feet centered at 10,10 from 0 to 90 degrees"
3. "Draw an arc through points (0,0), (5,5), and (10,0)"
4. "Draw a spline through (0,0), (5,3), (10,0), (15,5)"
5. "Draw a hermite curve through (0,0), (3,4), (6,1), (9,5)"
6. "Draw a circle at 5,5 with radius 3"
7. "Draw a rectangle from (0,0) to (10,5)"
8. "Draw a closed polyline connecting (0,0), (5,3), (10,0)"
9. "Draw an ellipse centered at 5,5 with x-radius 4 and y-radius 2, rotated 30 degrees"
10. "Change the line style of elements [id1, id2] to 'Medium Lines'"
11. Verify all geometry appears correctly and Ctrl+Z undoes each operation
